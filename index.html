<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Work Routing Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1 { margin-bottom: 5px; }
        
        /* Layout Structure */
        .container { display: flex; gap: 20px; margin-bottom: 20px; }
        #controls { 
            flex: 0 0 280px; /* Fixed width for controls */
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        #users-status { 
            flex-grow: 1; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        /* User Card Grid Layout */
        #userList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive columns */
            gap: 15px;
            margin-top: 15px;
        }

        /* Styling */
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 0; }
        hr { border-color: #eee; }
        
        button { padding: 8px 12px; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
        button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Button Colors */
        .btn-push { background-color: #007bff; color: white; }
        .btn-pull { background-color: #28a745; color: white; }
        .btn-complete { background-color: #ffc107; color: #333; }
        .btn-add-user { background-color: #6c757d; color: white; }
        .btn-logoff { background-color: #dc3545; color: white; }

        .btn-push:hover { background-color: #0056b3; }
        .btn-pull:hover { background-color: #1e7e34; }
        .btn-complete:hover { background-color: #e0a800; }
        .btn-logoff:hover { background-color: #c82333; }

        /* User Card Condensation */
        .user-card { 
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 5px; 
            background: #fafafa;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .user-card p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        .card-header h4 {
            margin: 0;
        }
        .card-actions {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 5px;
        }

        /* Log Styling */
        #log {
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .log-entry { margin-top: 5px; padding: 8px; border-left: 3px solid #007bff; background: #e9f7ff; font-size: 0.9em; }
        .red { color: #dc3545; font-weight: bold; }
        .green { color: #28a745; font-weight: bold; }
        .muted { color: #6c757d; }
    </style>
</head>
<body>

    <h1>Work Routing Simulator</h1>

    <div class="container">
        <div id="controls">
            <h2>Work & User Controls</h2>
            <button id="addUserBtn" class="btn-add-user">‚ûï Add User</button>
            
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox" id="clearWorkOnLogout" checked>
                Clear work capacity on logout?
            </label>
            <p class="muted">Max Capacity per user: **3** units</p>
            <hr>
            <button id="pushWorkBtn" class="btn-push">SYSTEM PUSH Work ‚û°Ô∏è</button>
            <p class="muted">Simulates new work entering the system.</p>
        </div>

        <div id="users-status">
            <h2>User Status (<span id="userCount">0</span> users online)</h2>
            <div id="userList">
                </div>
        </div>
    </div>

    <div id="log">
        <h2>Activity Log üìú</h2>
        </div>

    <script>
        const userList = [];
        const MAX_USERS = 5;
        const MAX_CAPACITY = 3;
        let workId = 1001;
        
        const addUserBtn = document.getElementById('addUserBtn');
        const pushWorkBtn = document.getElementById('pushWorkBtn');
        const userListDiv = document.getElementById('userList');
        const logDiv = document.getElementById('log');
        const userCountSpan = document.getElementById('userCount');
        const clearWorkCheckbox = document.getElementById('clearWorkOnLogout');

        // --- Utility Functions ---

        function shouldClearWorkOnLogout() {
            return clearWorkCheckbox.checked;
        }
        
        function logActivity(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `**[${new Date().toLocaleTimeString()}]** ${isError ? '<span class="red">' : ''}${message}${isError ? '</span>' : ''}`;
            // Insert at the top of the log
            logDiv.insertBefore(entry, logDiv.children[1]); 
        }

        function updateUI() {
            userListDiv.innerHTML = '';
            // Count users who are online (not logged off AND not away)
            userCountSpan.textContent = userList.filter(u => !u.isLoggedOff && !u.isAway).length; 

            userList.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';

                // Determine main status and card color
                let statusText;
                if (user.isLoggedOff) {
                    statusText = '<span class="red">OFFLINE</span>';
                    card.style.opacity = '0.7';
                    card.style.backgroundColor = '#fce4e4';
                } else if (user.isAway) {
                    statusText = '<span style="color: orange; font-weight: bold;">AWAY</span>';
                    card.style.opacity = '0.8';
                    card.style.backgroundColor = '#fffbeb';
                } else {
                    statusText = '<span class="green">ONLINE</span>';
                    card.style.opacity = '1';
                    card.style.backgroundColor = '#fafafa';
                }

                const capacityConsumed = user.workItems.length;
                const capacityClass = capacityConsumed === MAX_CAPACITY ? 'red' : (capacityConsumed === 0 ? 'green' : '');
                const latText = user.lastAssignmentTime ? user.lastAssignmentTime.toLocaleTimeString() : 'N/A';

                let cardContent = `
                    <div class="card-header">
                        <h4>${user.name}</h4>
                        ${statusText}
                    </div>
                    <div>
                        <p>Workload: <span class="${capacityClass}">**${capacityConsumed}**</span> / ${MAX_CAPACITY}</p>
                        <p>Work IDs: <span class="muted">${user.workItems.join(', ') || 'None'}</span></p>
                        <p>Login: ${user.loginDate.toLocaleTimeString()}</p>
                        <p>LAT: ${latText}</p>
                    </div>
                    <div class="card-actions"> `; // <-- The card-actions div is OPEN here

                // Render buttons based on state, appending to cardContent
                if (!user.isLoggedOff) {
                    // Logged In (Online or Away)
                    const completeDisabled = user.workItems.length === 0 ? 'disabled' : '';
                    const pullDisabled = user.isAway ? 'disabled' : '';

                    // Row 1: PULL and Complete (Always available when logged in)
                    cardContent += `<button class="btn-pull" ${pullDisabled} onclick="pullWork(${user.id})">PULL Work ‚¨ÖÔ∏è</button>`;
                    cardContent += `<button class="btn-complete" ${completeDisabled} onclick="completeWork(${user.id})">‚úÖ Complete</button>`;

                    // Row 2: Status Toggles
                    if (user.isAway) {
                        // Must provide Log Off and Go Online options
                        cardContent += `<button class="btn-logoff" onclick="logoffUser(${user.id})">üõë Log Off</button>`;
                        cardContent += `<button class="btn-pull" onclick="goOnline(${user.id})">‚ñ∂Ô∏è Go ONLINE</button>`;
                    } else {
                        // Must be ONLINE to see Log Off and Go Away
                        cardContent += `<button class="btn-logoff" onclick="logoffUser(${user.id})">üõë Log Off</button>`;
                        cardContent += `<button class="btn-add-user" onclick="goAway(${user.id})">‚è∏Ô∏è Go AWAY</button>`;
                    }
                } else {
                    // Logged Off
                    cardContent += `<button class="btn-pull" style="grid-column: span 2;" onclick="loginUser(${user.id})">‚úÖ Log Back In</button>`;
                }

                // FIX: Close the card-actions div here, at the end of content generation.
                cardContent += `</div>`; 

                // Assign the completed string to the card's innerHTML just once.
                card.innerHTML = cardContent;
                userListDiv.appendChild(card);
            });

            if (userList.length >= MAX_USERS) {
                addUserBtn.disabled = true;
                addUserBtn.textContent = 'Max Users Reached';
            } else {
                addUserBtn.disabled = false;
                addUserBtn.textContent = '‚ûï Add User';
            }
            // Disable PUSH if no one is online (not logged off AND not away)
            pushWorkBtn.disabled = userList.filter(u => !u.isLoggedOff && !u.isAway).length === 0; 
        }

        // --- User Management ---

        function addUser() {
            if (userList.length >= MAX_USERS) return;

            const newId = userList.length + 1;
            const newUser = {
                id: newId,
                name: `User ${newId}`,
                loginDate: new Date(),
                lastAssignmentTime: null, // Null if never assigned work
                workItems: [], // Array of work IDs
                isLoggedOff: false,
                isAway: false // <-- ADD THIS NEW STATUS
            };
            userList.push(newUser);
            logActivity(`**${newUser.name}** has logged in (Simulated Login Date: ${newUser.loginDate.toLocaleTimeString()}).`);
            updateUI();
        }

        // --- Logoff/Login Functions ---

        function logoffUser(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || user.isLoggedOff) { 
                return;
            }
            // Clear Away status if they were Away
            const wasAway = user.isAway;
            user.isAway = false; // Must clear away status as they are now logging off
            user.isLoggedOff = true;
            
            // ACTION: Always clear Last Assignment Time (LAT) on logout.
            const originalLAT = user.lastAssignmentTime;
            user.lastAssignmentTime = null;
            
            // Check the checkbox setting
            if (shouldClearWorkOnLogout()) {
                const clearedCount = user.workItems.length;
                user.workItems = [];
                logActivity(`**${user.name}** logged off. **Cleared ${clearedCount}** work item(s) due to setting.`);
            } else {
                logActivity(`**${user.name}** logged off. Workload retained (**${user.workItems.length}** item(s)).`);
            }

            updateUI();
        }

        function loginUser(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || !user.isLoggedOff) return;

            user.isLoggedOff = false;
            user.loginDate = new Date(); // New login time for PUSH priority
            logActivity(`**${user.name}** logged back in (New Login Date: ${user.loginDate.toLocaleTimeString()}).`);

            updateUI();
        }

        
        // --- Away Status Functions ---
        function goAway(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || user.isLoggedOff || user.isAway) return;

            user.isAway = true;
            // Workload, LAT, and Login Date remain untouched.
            logActivity(`**${user.name}** is now AWAY. Workload (${user.workItems.length}) retained, priority unchanged.`);
            updateUI();
        }

        function goOnline(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || !user.isAway) return;

            user.isAway = false;
            logActivity(`**${user.name}** is now ONLINE.`);
            updateUI();
        }
        // --- Routing Functions ---

        function assignWork(user, type) {
            if (user.workItems.length >= MAX_CAPACITY) {
                logActivity(`Cannot assign work to **${user.name}**. Capacity is full.`, true);
                return false;
            }

            const newWorkId = `W${workId++}`;
            user.workItems.push(newWorkId);

            // PUSH routing updates the LastAssignmentTime (LAT)
            if (type === 'PUSH') {
                user.lastAssignmentTime = new Date();
            }
            
            // PULL routing does NOT update LAT, per your specification
            
            logActivity(`${type} Work **${newWorkId}** assigned to **${user.name}**. Capacity: ${MAX_CAPACITY - user.workItems.length}.`);
            updateUI();
            return true;
        }

        function pullWork(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || user.isLoggedOff || user.isAway) { // <-- ADD isAway check
                logActivity(`**${user.name}** is unavailable and cannot PULL work.`, true);
                return;
            }
            
            logActivity(`**${user.name}** initiated PULL routing.`);
            assignWork(user, 'PULL');
        }

        function completeWork(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user || user.workItems.length === 0) return;

            const completedWorkId = user.workItems.pop();
            logActivity(`**${user.name}** completed work **${completedWorkId}**. Capacity released: ${MAX_CAPACITY - user.workItems.length}.`);
            updateUI();
        }

        function pushWork() {
            if (userList.length === 0) {
                logActivity('No users available to PUSH work to.', true);
                return;
            }

            logActivity('--- **SYSTEM PUSH ROUTING** initiated (New work entered the system) ---');

            // 1. Filter out users with full capacity AND users who are logged off OR who are away
            let candidates = userList.filter(u => u.workItems.length < MAX_CAPACITY && !u.isLoggedOff && !u.isAway); 

            if (candidates.length === 0) {
                logActivity('No logged-in users have spare capacity to receive PUSH work.', true);
                return;
            }

            // 2. Primary Order: Capacity Spare (Most spare capacity first)
            candidates.sort((a, b) => {
                const capacityA = MAX_CAPACITY - a.workItems.length;
                const capacityB = MAX_CAPACITY - b.workItems.length;
                return capacityB - capacityA; // Descending: B - A
            });

            // 3. Secondary Order: Last Assignment Time (LAT) or Login Date (Oldest first)
            candidates.sort((a, b) => {
                const capacityA = MAX_CAPACITY - a.workItems.length;
                const capacityB = MAX_CAPACITY - b.workItems.length;

                // Only use LAT/Login logic to break ties in capacity
                if (capacityA !== capacityB) {
                    return 0; // Capacity difference already handled by the first sort, do not reorder here.
                }

                const latA = a.lastAssignmentTime || a.loginDate;
                const latB = b.lastAssignmentTime || b.loginDate;
                
                // Oldest time first: A - B (Date objects compare as timestamps)
                return latA.getTime() - latB.getTime();
            });

            const selectedUser = candidates[0];
            const topCapacity = MAX_CAPACITY - candidates[0].workItems.length;
            const effectiveTime = selectedUser.lastAssignmentTime || selectedUser.loginDate;
            
            // Calculate the total number of users tied for the top capacity
            const totalTiedUsers = candidates.filter(c => (MAX_CAPACITY - c.workItems.length) === topCapacity).length;
            
            // Determine if a tie exists (i.e., if more than one user has the top capacity)
            const capacityTie = totalTiedUsers > 1;
            
            // Log the selection reason
            let logMessage = `**${selectedUser.name}** was selected for PUSH work.`;
            
            if (capacityTie) {
                const otherTiedUsers = totalTiedUsers - 1; // Subtract the selected user
                logMessage += `<br/>- **Reason 1 (Primary Tie):** Tied with ${otherTiedUsers} other user(s) for the most spare capacity (**${topCapacity}** units).`;
                logMessage += `<br/>- **Reason 2 (Tie-breaker):** Had the oldest effective assignment time: **${effectiveTime.toLocaleTimeString()}** (LAT or Login Date).`;
            } else {
                logMessage += `<br/>- **Reason 1 (Primary):** Has the most spare capacity (**${topCapacity}** units).`;
            }
            
            logActivity(logMessage);

            // Assign the work
            assignWork(selectedUser, 'PUSH');
        }

        // --- Event Listeners and Initial Setup ---

        addUserBtn.addEventListener('click', addUser);
        pushWorkBtn.addEventListener('click', pushWork);

        // Initial log entry
        logActivity('Welcome to the Work Routing Simulator. Add users to begin.');
    </script>
</body>
</html>
